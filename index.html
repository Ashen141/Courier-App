<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courier Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .search-results { max-height: 150px; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    
    <!-- Auth Container -->
    <div id="authContainer">
        <!-- Login Page -->
        <main id="login-page" class="page flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Login</h2>
                <form id="loginForm" class="space-y-6">
                    <div><label for="loginUsername" class="block text-sm font-medium text-slate-600 mb-1">Username</label><input type="text" id="loginUsername" class="w-full px-3 py-2 border border-slate-300 rounded-md" required value="Admin"></div>
                    <div><label for="loginPassword" class="block text-sm font-medium text-slate-600 mb-1">Password</label><input type="password" id="loginPassword" class="w-full px-3 py-2 border border-slate-300 rounded-md" required value="Admin"></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Login</button>
                    <p class="text-center text-sm">Don't have an account? <a href="#register" id="showRegister" class="text-indigo-600 hover:underline">Register here</a></p>
                </form>
            </div>
        </main>

        <!-- Register Page -->
        <main id="register-page" class="page hidden flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Register</h2>
                <form id="registerForm" class="space-y-6">
                    <div><label for="registerUsername" class="block text-sm font-medium text-slate-600 mb-1">Username</label><input type="text" id="registerUsername" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div>
                    <div><label for="registerPassword" class="block text-sm font-medium text-slate-600 mb-1">Password</label><input type="password" id="registerPassword" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Register</button>
                    <p class="text-center text-sm">Already have an account? <a href="#login" id="showLogin" class="text-indigo-600 hover:underline">Login here</a></p>
                </form>
            </div>
        </main>
    </div>
    
    <div id="appContainer" class="hidden">
        <div class="flex min-h-screen">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-slate-800 text-white flex flex-col fixed h-full">
                <div class="p-6 text-2xl font-bold border-b border-slate-700"><i class="fas fa-box-open mr-2"></i> CourierApp</div>
                <nav id="sidebarNav" class="flex-1 mt-6">
                    <a href="#dashboard" class="nav-link block py-3 px-6 text-lg bg-slate-900/50 text-indigo-400 font-semibold"><i class="fas fa-tachometer-alt w-8 text-center"></i> Dashboard</a>
                    <a href="#create-shipment" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-plus-circle w-8 text-center"></i> Create Shipment</a>
                    <a href="#chase-jobs" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-briefcase w-8 text-center"></i> Chase Jobs</a>
                    <a href="#address-book" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-address-book w-8 text-center"></i> Address Book</a>
                    <a href="#elements" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-cubes w-8 text-center"></i> Elements</a>
                    <a href="#delivery-notes" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-file-invoice w-8 text-center"></i> Delivery Notes</a>
                    <a href="#settings" class="nav-link block py-3 px-6 text-lg hover:bg-slate-700 transition duration-200"><i class="fas fa-cog w-8 text-center"></i> Settings</a>
                </nav>
                <div class="p-6 border-t border-slate-700"><div class="flex items-center"><img src="https://i.pravatar.cc/40" alt="Admin" class="rounded-full w-10 h-10"><div class="ml-4"><p id="loggedInUser" class="font-semibold">Admin User</p><a href="#" id="logoutBtn" class="text-sm text-slate-400 hover:text-white">Logout</a></div></div></div>
            </aside>

            <!-- Main Content Area -->
            <div id="mainContent" class="ml-64 flex-1">
                <!-- All page content goes here -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="updateStatusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-md w-full"><div class="flex justify-between items-center p-6 border-b"><h3 class="text-2xl font-bold text-slate-800">Update Shipment Status</h3><button id="closeUpdateModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button></div><form id="updateStatusForm" class="p-8 space-y-6"><input type="hidden" id="updateShipmentId"><div><p class="mb-2">Tracking #: <strong id="modalTrackingId"></strong></p><label for="newStatus" class="block text-sm font-medium text-slate-600 mb-1">New Status</label><select id="newStatus" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"><option>Pending</option><option>In Transit</option><option>Out for Delivery</option><option>Delivered</option><option>Delayed</option></select></div><div class="flex justify-end items-center pt-6 border-t"><button type="button" id="cancelUpdateModalBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4 hover:bg-slate-200 transition">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition shadow-lg">Save Status</button></div></form></div></div>
    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-md w-full"><div class="flex justify-between items-center p-6 border-b"><h3 class="text-2xl font-bold text-slate-800">Chase Login Credentials</h3><button id="closeImportModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button></div><form id="importForm" class="p-8 space-y-6"><div><label for="apiUsername" class="block text-sm font-medium text-slate-600 mb-1">Username</label><input type="text" id="apiUsername" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required value="apiuser@chase.co.za"></div><div><label for="apiPassword" class="block text-sm font-medium text-slate-600 mb-1">Password</label><input type="password" id="apiPassword" class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required></div><div class="flex justify-end items-center pt-6 border-t"><button type="button" id="cancelImportModalBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4 hover:bg-slate-200 transition">Cancel</button><button type="submit" id="submitImportBtn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-700 transition shadow-lg">Import Jobs</button></div></form></div></div>
    <div id="editAddressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-md w-full"><div class="flex justify-between items-center p-6 border-b"><h3 class="text-2xl font-bold text-slate-800">Edit Address</h3><button id="closeEditAddressModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button></div><form id="editAddressForm" class="p-8 space-y-6"><input type="hidden" id="editAddressId"><div><label for="editAddressName" class="block text-sm font-medium text-slate-600 mb-1">Name / Company</label><input type="text" id="editAddressName" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div><div><label for="editAddressContactPerson" class="block text-sm font-medium text-slate-600 mb-1">Contact Person</label><input type="text" id="editAddressContactPerson" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="editAddressPhone" class="block text-sm font-medium text-slate-600 mb-1">Phone Number</label><input type="tel" id="editAddressPhone" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="editAddressText" class="block text-sm font-medium text-slate-600 mb-1">Address</label><textarea id="editAddressText" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div><div class="flex justify-end items-center pt-6 border-t"><button type="button" id="cancelEditAddressModalBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4 hover:bg-slate-200 transition">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition shadow-lg">Save Changes</button></div></form></div></div>
    <div id="editElementModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-md w-full"><div class="flex justify-between items-center p-6 border-b"><h3 class="text-2xl font-bold text-slate-800">Edit Element</h3><button id="closeEditElementModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button></div><form id="editElementForm" class="p-8 space-y-6"><input type="hidden" id="editElementId"><div><label for="editElementBrand" class="block text-sm font-medium text-slate-600 mb-1">Brand</label><input type="text" id="editElementBrand" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div><div><label for="editElementProduct" class="block text-sm font-medium text-slate-600 mb-1">Product</label><input type="text" id="editElementProduct" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="editElementColor" class="block text-sm font-medium text-slate-600 mb-1">Color</label><input type="text" id="editElementColor" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div><div><label for="editElementDescription" class="block text-sm font-medium text-slate-600 mb-1">Description</label><textarea id="editElementDescription" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div><div class="flex justify-end items-center pt-6 border-t"><button type="button" id="cancelEditElementModalBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4 hover:bg-slate-200 transition">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 transition shadow-lg">Save Changes</button></div></form></div></div>
    <div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-md w-full"><div class="p-6 text-center"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h3 class="text-2xl font-bold text-slate-800">Are you sure?</h3><p class="text-slate-500 mt-2">Do you really want to delete this item? This process cannot be undone.</p></div><div class="flex justify-center items-center p-6 bg-slate-50 rounded-b-lg space-x-4"><button type="button" id="cancelDeleteBtn" class="text-slate-600 font-semibold py-2 px-6 rounded-lg hover:bg-slate-200 transition">Cancel</button><button type="button" id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition shadow-lg">Delete</button></div></div></div>
    <div id="editShipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden"><div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full"><div class="flex justify-between items-center p-6 border-b"><h3 class="text-2xl font-bold text-slate-800">Edit Shipment</h3><button id="closeEditShipmentModalBtn" class="text-slate-500 hover:text-slate-800 text-3xl">&times;</button></div><form id="editShipmentForm" class="p-8 space-y-6 max-h-[80vh] overflow-y-auto"></form></div></div>

    <script>
        const API_URL = '/api';
        let shipmentsCache = [];
        let importedJobsCache = [];
        let addressBookCache = [];
        let elementsCache = [];
        let deliveryNotesCache = [];
        
        const mainContent = document.getElementById('mainContent');
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginPage = document.getElementById('login-page');
        const registerPage = document.getElementById('register-page');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');
        const logoutBtn = document.getElementById('logoutBtn');
        const loggedInUser = document.getElementById('loggedInUser');

        const pages = {
            dashboard: `
                <main id="dashboard" class="page p-8">
                    <div id="notificationArea" class="mb-4"></div>
                    <header class="flex flex-col items-center text-center mb-8">
                        <div><h1 class="text-3xl font-bold text-slate-800">Shipments Dashboard</h1><p class="text-slate-500">Manually created shipments and deliveries.</p></div>
                        <div class="flex items-center space-x-4 mt-4">
                            <div class="relative"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i><input type="text" id="searchInput" placeholder="Search waybill..." class="pl-10 pr-4 py-2 rounded-lg border bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64"></div>
                            <a href="#create-shipment" class="nav-link bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center shadow-lg"><i class="fas fa-plus mr-2"></i> Create New Shipment</a>
                        </div>
                    </header>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-slate-500 text-sm font-semibold">TOTAL SHIPMENTS</p><p id="totalShipmentsStat" class="text-3xl font-bold text-slate-800">0</p></div><div class="bg-indigo-100 text-indigo-600 p-4 rounded-full"><i class="fas fa-boxes fa-lg"></i></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-slate-500 text-sm font-semibold">IN TRANSIT</p><p id="inTransitStat" class="text-3xl font-bold text-slate-800">0</p></div><div class="bg-blue-100 text-blue-600 p-4 rounded-full"><i class="fas fa-shipping-fast fa-lg"></i></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-slate-500 text-sm font-semibold">DELIVERED</p><p id="deliveredStat" class="text-3xl font-bold text-slate-800">0</p></div><div class="bg-green-100 text-green-600 p-4 rounded-full"><i class="fas fa-check-circle fa-lg"></i></div></div><div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between"><div><p class="text-slate-500 text-sm font-semibold">ISSUES / DELAYED</p><p id="issuesStat" class="text-3xl font-bold text-slate-800">0</p></div><div class="bg-red-100 text-red-600 p-4 rounded-full"><i class="fas fa-exclamation-triangle fa-lg"></i></div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-slate-800 mb-4">Recent Shipments</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4 text-sm font-semibold text-slate-600">TRACKING #</th><th class="p-4 text-sm font-semibold text-slate-600">JOB NO</th><th class="p-4 text-sm font-semibold text-slate-600">CE #</th><th class="p-4 text-sm font-semibold text-slate-600 w-1/5">RECIPIENT</th><th class="p-4 text-sm font-semibold text-slate-600 w-1/5">DESTINATION</th><th class="p-4 text-sm font-semibold text-slate-600">STATUS</th><th class="p-4 text-sm font-semibold text-slate-600">CREATED ON</th><th class="p-4 text-sm font-semibold text-slate-600 text-center">ACTIONS</th></tr></thead><tbody id="shipmentsTableBody"><tr><td colspan="8" class="text-center p-8 text-slate-500">Loading shipments...</td></tr></tbody></table></div></div>
                </main>
            `,
            'create-shipment': `
                <main id="create-shipment" class="page p-8">
                    <header class="text-center mb-8"><div><h1 class="text-3xl font-bold text-slate-800">Create New Shipment</h1><p class="text-slate-500">Fill in the details below to create a new shipment.</p></div></header>
                    <div class="bg-white p-8 rounded-lg shadow-md">
                        <form id="shipmentForm" class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Sender Section -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-slate-700 border-b pb-2">Sender Information</h4>
                                    <div><label for="ceNumber" class="block text-sm font-medium text-slate-600 mb-1">CE Number</label><input type="text" name="ceNumber" id="ceNumber" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div><label for="associatedJobNo" class="block text-sm font-medium text-slate-600 mb-1">Job Number</label><input type="text" name="associatedJobNo" id="associatedJobNo" class="w-full px-3 py-2 border border-slate-300 rounded-md bg-slate-100" readonly></div>
                                    <div class="relative">
                                        <label for="senderName" class="block text-sm font-medium text-slate-600 mb-1">Company / Customer Name</label>
                                        <input type="text" name="senderName" id="senderName" class="w-full px-3 py-2 border border-slate-300 rounded-md" required autocomplete="off">
                                        <div id="senderResults" class="search-results absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden"></div>
                                    </div>
                                    <div><label for="senderContact" class="block text-sm font-medium text-slate-600 mb-1">Contact Person (AE)</label><input type="text" name="senderContact" id="senderContact" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div><label for="senderAddress" class="block text-sm font-medium text-slate-600 mb-1">Collection Address</label><textarea name="senderAddress" id="senderAddress" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 mb-1">Elements</label>
                                        <div id="elementsList" class="space-y-2">
                                            <div class="flex items-center space-x-2 text-sm font-semibold text-slate-500">
                                                <div class="w-8">No.</div>
                                                <div class="flex-1">Description</div>
                                                <div class="w-24">Quantity</div>
                                                <div class="w-8"></div>
                                            </div>
                                        </div>
                                        <button type="button" id="addElementBtn" class="mt-2 text-sm text-indigo-600 hover:underline">+ Add Element</button>
                                    </div>
                                </div>
                                <!-- Recipient Section -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-slate-700 border-b pb-2">Recipient Information</h4>
                                    <div class="relative">
                                        <label for="recipientName" class="block text-sm font-medium text-slate-600 mb-1">Search or Enter Name</label>
                                        <input type="text" name="recipientName" id="recipientName" class="w-full px-3 py-2 border border-slate-300 rounded-md" required autocomplete="off">
                                        <div id="recipientResults" class="search-results absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden"></div>
                                    </div>
                                    <div><label for="recipientContact" class="block text-sm font-medium text-slate-600 mb-1">Contact Person</label><input type="text" name="recipientContact" id="recipientContact" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div><label for="recipientAddress" class="block text-sm font-medium text-slate-600 mb-1">Address</label><textarea name="recipientAddress" id="recipientAddress" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div>
                                     <div><label for="courier_charge" class="block text-sm font-medium text-slate-600 mb-1">Courier Charge (R)</label><input type="number" name="courier_charge" id="courier_charge" class="w-full px-3 py-2 border border-slate-300 rounded-md" step="0.01" placeholder="0.00"></div>
                                </div>
                            </div>
                            <div class="flex justify-end items-center pt-6 border-t mt-4"><button type="button" id="cancelShipmentBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4">Cancel</button><button type="submit" id="saveShipmentBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Generate Waybill & Save</button></div>
                        </form>
                    </div>
                </main>
            `,
            'chase-jobs': `
                <main id="chase-jobs" class="page p-8">
                     <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-slate-800">Imported Chase Jobs</h1>
                            <p class="text-slate-500">Live data from the Chase API integration.</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="chaseSearchInput" placeholder="Search by CE, Job # or Client..." class="pl-10 pr-4 py-2 rounded-lg border bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 w-72">
                            </div>
                            <button id="openImportModalBtn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition duration-300 flex items-center shadow-lg"><i class="fas fa-download mr-2"></i> Import from Chase</button>
                        </div>
                    </header>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-slate-800 mb-4">Job List</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4 text-sm font-semibold text-slate-600 w-1/4">CE Numbers</th><th class="p-4 text-sm font-semibold text-slate-600">Job No</th><th class="p-4 text-sm font-semibold text-slate-600">Customer Name</th><th class="p-4 text-sm font-semibold text-slate-600">Product Name</th><th class="p-4 text-sm font-semibold text-slate-600">AE</th><th class="p-4 text-sm font-semibold text-slate-600">Description</th></tr></thead><tbody id="chaseJobsTableBody"><tr><td colspan="6" class="text-center p-8 text-slate-500">Loading jobs...</td></tr></tbody></table></div></div>
                </main>
            `,
            'address-book': `
                <main id="address-book" class="page p-8">
                    <header class="text-center mb-8"><div><h1 class="text-3xl font-bold text-slate-800">Address Book</h1><p class="text-slate-500">Manage sender and recipient addresses.</p></div></header>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Add New Address</h2>
                            <form id="addAddressForm" class="space-y-4">
                                <div><label for="addressName" class="block text-sm font-medium text-slate-600 mb-1">Name / Company</label><input type="text" id="addressName" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div>
                                <div><label for="addressContactPerson" class="block text-sm font-medium text-slate-600 mb-1">Contact Person</label><input type="text" id="addressContactPerson" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                <div><label for="addressPhone" class="block text-sm font-medium text-slate-600 mb-1">Phone Number</label><input type="tel" id="addressPhone" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                <div><label for="addressText" class="block text-sm font-medium text-slate-600 mb-1">Address</label><textarea id="addressText" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div>
                                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Address</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Saved Addresses</h2>
                            <div class="overflow-x-auto max-h-[60vh]"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4 text-sm font-semibold text-slate-600">Name</th><th class="p-4 text-sm font-semibold text-slate-600">Contact Person</th><th class="p-4 text-sm font-semibold text-slate-600">Address</th><th class="p-4 text-sm font-semibold text-slate-600">Actions</th></tr></thead><tbody id="addressBookTableBody"></tbody></table></div>
                        </div>
                    </div>
                </main>
            `,
            'elements': `
                <main id="elements" class="page p-8">
                    <header class="text-center mb-8"><div><h1 class="text-3xl font-bold text-slate-800">Elements</h1><p class="text-slate-500">Manage branding and product elements.</p></div></header>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Add New Element</h2>
                            <form id="addElementForm" class="space-y-4">
                                <div><label for="elementBrand" class="block text-sm font-medium text-slate-600 mb-1">Brand</label><input type="text" id="elementBrand" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div>
                                <div><label for="elementProduct" class="block text-sm font-medium text-slate-600 mb-1">Product</label><input type="text" id="elementProduct" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                <div><label for="elementColor" class="block text-sm font-medium text-slate-600 mb-1">Color</label><input type="text" id="elementColor" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                <div><label for="elementDescription" class="block text-sm font-medium text-slate-600 mb-1">Description</label><textarea id="elementDescription" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div>
                                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Element</button>
                            </form>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Saved Elements</h2>
                            <div class="overflow-x-auto max-h-[60vh]"><table class="w-full text-left"><thead class="bg-slate-50 border-b"><tr><th class="p-4 text-sm font-semibold text-slate-600">Brand</th><th class="p-4 text-sm font-semibold text-slate-600">Product</th><th class="p-4 text-sm font-semibold text-slate-600">Color</th><th class="p-4 text-sm font-semibold text-slate-600">Description</th><th class="p-4 text-sm font-semibold text-slate-600">Actions</th></tr></thead><tbody id="elementsTableBody"></tbody></table></div>
                        </div>
                    </div>
                </main>
            `,
            'delivery-notes': `
                <main id="delivery-notes" class="page p-8">
                    <header class="text-center mb-8"><div><h1 class="text-3xl font-bold text-slate-800">Delivery Notes</h1><p class="text-slate-500">Create and manage delivery notes.</p></div></header>
                    <div class="space-y-8 max-w-5xl mx-auto">
                        <div class="bg-white p-8 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-6 border-b pb-4">Create New Note</h2>
                            <form id="addDeliveryNoteForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="relative">
                                        <label for="dnClientName" class="block text-sm font-medium text-slate-600 mb-1">Client Name</label>
                                        <input type="text" id="dnClientName" class="w-full px-3 py-2 border border-slate-300 rounded-md" required autocomplete="off">
                                        <div id="dnClientResults" class="search-results absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden"></div>
                                    </div>
                                    <div><label for="dnDate" class="block text-sm font-medium text-slate-600 mb-1">Date</label><input type="date" id="dnDate" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></div>
                                    <div><label for="dnContactPerson" class="block text-sm font-medium text-slate-600 mb-1">Contact Person</label><input type="text" id="dnContactPerson" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div class="md:col-span-3"><label for="dnAddress" class="block text-sm font-medium text-slate-600 mb-1">Delivery Address</label><textarea id="dnAddress" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-md" required></textarea></div>
                                    <div><label for="dnContactNumber" class="block text-sm font-medium text-slate-600 mb-1">Contact Number</label><input type="text" id="dnContactNumber" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div><label for="dnJobNo" class="block text-sm font-medium text-slate-600 mb-1">Job Number</label><input type="text" id="dnJobNo" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                    <div><label for="dnCeNumber" class="block text-sm font-medium text-slate-600 mb-1">CE Number</label><input type="text" id="dnCeNumber" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                                </div>
                                
                                <div class="pt-4 border-t">
                                    <h3 class="text-lg font-semibold text-slate-700 mb-2">Items</h3>
                                    <div id="dnItemsContainer" class="space-y-2">
                                        <div class="grid grid-cols-12 gap-2 items-center text-sm font-semibold text-slate-500">
                                            <div class="col-span-2">Qty</div>
                                            <div class="col-span-6">Description</div>
                                            <div class="col-span-3">Unit Price (R)</div>
                                            <div class="col-span-1"></div>
                                        </div>
                                    </div>
                                    <button type="button" id="addDnItemBtn" class="mt-2 text-sm text-indigo-600 hover:underline">+ Add Item</button>
                                </div>
                                
                                <div class="pt-4 border-t flex justify-end">
                                    <div class="w-full max-w-sm space-y-2">
                                        <div class="flex justify-between items-center text-sm"><span class="font-semibold text-slate-600">Subtotal:</span><span id="dnSubtotal">R 0.00</span></div>
                                        <div class="flex justify-between items-center text-sm"><span class="font-semibold text-slate-600">VAT (15%):</span><span id="dnVat">R 0.00</span></div>
                                        <div class="flex justify-between items-center font-bold mt-2 text-lg"><span class="text-slate-800">Total:</span><span id="dnTotal">R 0.00</span></div>
                                        <button type="submit" class="w-full mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Note</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Saved Delivery Notes</h2>
                            <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 border-b sticky top-0"><tr><th class="p-4 text-sm font-semibold text-slate-600">DN #</th><th class="p-4 text-sm font-semibold text-slate-600">Client</th><th class="p-4 text-sm font-semibold text-slate-600">Date</th><th class="p-4 text-sm font-semibold text-slate-600">Job No</th><th class="p-4 text-sm font-semibold text-slate-600">Total</th><th class="p-4 text-sm font-semibold text-slate-600 text-center">Actions</th></tr></thead><tbody id="deliveryNotesTableBody"></tbody></table></div>
                        </div>
                    </div>
                </main>
            `,
            'settings': `
                <main id="settings" class="page p-8">
                    <header class="text-center mb-8"><div><h1 class="text-3xl font-bold text-slate-800">Settings</h1><p class="text-slate-500">Configure application settings.</p></div></header>
                    <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                        <form id="settingsForm" class="space-y-6">
                            <h2 class="text-xl font-bold text-slate-800 border-b pb-3">Waybill Customization</h2>
                            <div>
                                <label for="waybillHeader" class="block text-sm font-medium text-slate-600 mb-1">Header Text</label>
                                <input type="text" id="waybillHeader" name="header" class="w-full px-3 py-2 border border-slate-300 rounded-md" placeholder="e.g., Your Company Name">
                            </div>
                            <div>
                                <label for="waybillFooter" class="block text-sm font-medium text-slate-600 mb-1">Footer Text</label>
                                <input type="text" id="waybillFooter" name="footer" class="w-full px-3 py-2 border border-slate-300 rounded-md" placeholder="e.g., Thank you for your business!">
                            </div>
                            <div>
                                <label for="waybillDisclaimer" class="block text-sm font-medium text-slate-600 mb-1">Disclaimer</label>
                                <textarea id="waybillDisclaimer" name="disclaimer" rows="4" class="w-full px-3 py-2 border border-slate-300 rounded-md" placeholder="e.g., Goods received in good condition..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Company Logo</label>
                                <input type="file" id="logoUpload" accept="image/png, image/jpeg" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                                <input type="hidden" id="logoData" name="logo">
                                <div id="logoPreview" class="mt-4"></div>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </main>
            `
        };

        const getStatusBadge = (status) => { return `<span class="${{'Delivered':'bg-green-100 text-green-800','In Transit':'bg-blue-100 text-blue-800','Out for Delivery':'bg-yellow-100 text-yellow-800','Delayed':'bg-red-100 text-red-800','Pending':'bg-slate-200 text-slate-800','Imported':'bg-purple-100 text-purple-800'}[status] || 'bg-gray-100 text-gray-800'} text-xs font-semibold px-2 py-1 rounded-full">${status}</span>`; };
        
        const displayShipments = () => {
            const shipmentsTableBody = document.getElementById('shipmentsTableBody');
            if (!shipmentsTableBody) return;
            const stats = { total: shipmentsCache.length, inTransit: 0, delivered: 0, issues: 0 };
            shipmentsTableBody.innerHTML = '';
            if (shipmentsCache.length === 0) {
                shipmentsTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-slate-500">No manual shipments created yet.</td></tr>';
            } else {
                shipmentsCache.forEach(shipment => {
                    if(shipment.status === 'In Transit') stats.inTransit++;
                    if(shipment.status === 'Delivered') stats.delivered++;
                    if(shipment.status === 'Delayed') stats.issues++;
                    const createdAtDate = shipment.createdAt ? new Date(shipment.createdAt).toLocaleDateString() : 'N/A';
                    const row = `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="p-4 font-bold text-slate-800">${shipment.trackingNumber}</td>
                            <td class="p-4 text-slate-600">${shipment.associatedJobNo || '-'}</td>
                            <td class="p-4 text-slate-600">${shipment.ceNumber || '-'}</td>
                            <td class="p-4 text-slate-600 w-1/5">${shipment.recipientName}</td>
                            <td class="p-4 text-slate-600 w-1/5">${shipment.recipientAddress}</td>
                            <td class="p-4">${getStatusBadge(shipment.status)}</td>
                            <td class="p-4 text-slate-600">${createdAtDate}</td>
                             <td class="p-4 space-x-4 whitespace-nowrap text-center">
                                <button data-id="${shipment.trackingNumber}" class="edit-shipment-btn text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button>
                                <button data-id="${shipment.trackingNumber}" class="delete-shipment-btn text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash-alt"></i></button>
                                <button data-id="${shipment.trackingNumber}" class="print-waybill-btn text-indigo-600 hover:text-indigo-800" title="Print Waybill"><i class="fas fa-print"></i></button>
                            </td>
                        </tr>`;
                    shipmentsTableBody.innerHTML += row;
                });
            }
            document.getElementById('totalShipmentsStat').textContent = stats.total;
            document.getElementById('inTransitStat').textContent = stats.inTransit;
            document.getElementById('deliveredStat').textContent = stats.delivered;
            document.getElementById('issuesStat').textContent = stats.issues;
        };

        const displayChaseJobs = (jobsToDisplay) => {
            const chaseJobsTableBody = document.getElementById('chaseJobsTableBody');
            if (!chaseJobsTableBody) return;
            const jobs = jobsToDisplay || importedJobsCache.slice(0, 10);
            chaseJobsTableBody.innerHTML = '';
            if (jobs.length === 0) {
                chaseJobsTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">No jobs found.</td></tr>';
                return;
            }
            jobs.forEach(job => {
                const row = `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 text-slate-600 w-1/4 truncate">${job.ceNumbers || 'N/A'}</td>
                        <td class="p-4 text-slate-600">${job.jobNo || 'N/A'}</td>
                        <td class="p-4 font-bold text-slate-800">${job.customerName || 'N/A'}</td>
                        <td class="p-4 text-slate-600">${job.productName || 'N/A'}</td>
                        <td class="p-4 text-slate-600">${job.accountExecutive || 'N/A'}</td>
                        <td class="p-4 text-slate-600 truncate max-w-xs">${job.description || 'N/A'}</td>
                    </tr>`;
                chaseJobsTableBody.innerHTML += row;
            });
        };

        const displayAddresses = async () => {
            const addressBookTableBody = document.getElementById('addressBookTableBody');
            if (!addressBookTableBody) return;
            addressBookTableBody.innerHTML = '';
            if (addressBookCache.length === 0) {
                addressBookTableBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-slate-500">No addresses saved yet.</td></tr>';
                return;
            }
            addressBookCache.forEach(addr => {
                const row = `<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-slate-800">${addr.name}</td><td class="p-4 text-slate-600">${addr.contactPerson || ''}</td><td class="p-4 text-slate-600">${addr.address}</td><td class="p-4 space-x-4 whitespace-nowrap"><button data-id="${addr.id}" class="edit-address-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${addr.id}" class="delete-address-btn text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                addressBookTableBody.innerHTML += row;
            });
        };

        const displayElements = async () => {
            const elementsTableBody = document.getElementById('elementsTableBody');
            if(!elementsTableBody) return;
            elementsTableBody.innerHTML = '';
            if (elementsCache.length === 0) {
                elementsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-500">No elements saved yet.</td></tr>';
                return;
            }
            elementsCache.forEach(el => {
                const row = `<tr class="border-b hover:bg-slate-50"><td class="p-4 font-bold text-slate-800">${el.brand}</td><td class="p-4 text-slate-600">${el.product || ''}</td><td class="p-4 text-slate-600">${el.color || ''}</td><td class="p-4 text-slate-600">${el.description}</td><td class="p-4 space-x-4 whitespace-nowrap"><button data-id="${el.id}" class="edit-element-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${el.id}" class="delete-element-btn text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                elementsTableBody.innerHTML += row;
            });
        };

        const displayDeliveryNotes = () => {
            const tableBody = document.getElementById('deliveryNotesTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (deliveryNotesCache.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">No delivery notes saved yet.</td></tr>';
                return;
            }
            deliveryNotesCache.forEach(note => {
                const row = `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-4 font-bold text-slate-800">${note.deliveryNoteNumber}</td>
                        <td class="p-4 text-slate-600">${note.clientName}</td>
                        <td class="p-4 text-slate-600">${new Date(note.date).toLocaleDateString()}</td>
                        <td class="p-4 text-slate-600">${note.jobNo || '-'}</td>
                        <td class="p-4 text-slate-600">R ${note.total.toFixed(2)}</td>
                        <td class="p-4 space-x-4 whitespace-nowrap text-center">
                            <button data-id="${note.id}" class="delete-dn-btn text-red-600 hover:text-red-800" title="Delete"><i class="fas fa-trash-alt"></i></button>
                            <button data-id="${note.id}" class="print-dn-btn text-indigo-600 hover:text-indigo-800" title="Print PDF"><i class="fas fa-print"></i></button>
                        </td>
                    </tr>`;
                tableBody.innerHTML += row;
            });
        };
        
        const loadInitialData = async () => {
            try {
                const response = await fetch(`${API_URL}/all-data`);
                if (!response.ok) throw new Error('Failed to fetch initial data');
                const data = await response.json();
                shipmentsCache = data.shipments || [];
                addressBookCache = data.addresses || [];
                elementsCache = data.elements || [];
                importedJobsCache = data.chaseJobs || [];
                deliveryNotesCache = data.deliveryNotes || [];
                
                const pageId = window.location.hash.substring(1) || 'dashboard';
                renderPage(pageId);
            } catch (error) {
                console.error("Fatal Error: Could not load initial data.", error);
                mainContent.innerHTML = `<div class="p-8 text-center text-red-500">
                    <h1 class="text-2xl font-bold">Connection Failed</h1>
                    <p>Could not connect to the server. Please ensure the server is running and refresh the page.</p>
                </div>`;
            }
        };

        const populateJobsDropdown = () => {
            const jobSelector = document.getElementById('jobSelector');
            if(!jobSelector) return;
            jobSelector.innerHTML = '<option value="">-- Manually Enter Details --</option>';
            importedJobsCache.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                option.textContent = `${job.jobNo || 'No Job #'} - ${job.customerName}`;
                jobSelector.appendChild(option);
            });
        };

        const handleAddressSearch = (inputElem, resultsElem, contactElem, addressElem, numberElem) => {
            inputElem.addEventListener('input', () => {
                const query = inputElem.value.toLowerCase();
                if (query.length < 2) {
                    resultsElem.innerHTML = '';
                    resultsElem.classList.add('hidden');
                    return;
                }
                const matches = addressBookCache.filter(addr => addr.name.toLowerCase().includes(query));
                resultsElem.innerHTML = '';
                if (matches.length > 0) {
                    matches.forEach(match => {
                        const div = document.createElement('div');
                        div.textContent = match.name;
                        div.className = 'p-2 hover:bg-slate-100 cursor-pointer';
                        div.addEventListener('click', () => {
                            inputElem.value = match.name;
                            if(contactElem) contactElem.value = match.contactPerson || '';
                            if(addressElem) addressElem.value = match.address || '';
                            if(numberElem) numberElem.value = match.phone || '';
                            resultsElem.classList.add('hidden');
                        });
                        resultsElem.appendChild(div);
                    });
                    resultsElem.classList.remove('hidden');
                } else {
                    resultsElem.classList.add('hidden');
                }
            });
        };

        const handleElementSearch = (inputElem, resultsElem) => {
            const query = inputElem.value.toLowerCase();
            if (query.length < 2) {
                resultsElem.innerHTML = '';
                resultsElem.classList.add('hidden');
                return;
            }
            const matches = elementsCache.filter(el => (el.brand && el.brand.toLowerCase().includes(query)) || (el.product && el.product.toLowerCase().includes(query)));
            resultsElem.innerHTML = '';
            if (matches.length > 0) {
                matches.forEach(match => {
                    const div = document.createElement('div');
                    div.textContent = `${match.brand} - ${match.product}`;
                    div.className = 'p-2 hover:bg-slate-100 cursor-pointer';
                    div.addEventListener('click', () => {
                        inputElem.value = `${match.brand} - ${match.product}`;
                        resultsElem.classList.add('hidden');
                    });
                    resultsElem.appendChild(div);
                });
                resultsElem.classList.remove('hidden');
            } else {
                resultsElem.classList.add('hidden');
            }
        };

        const loadSettings = async () => {
            try {
                const response = await fetch(`${API_URL}/settings/waybill`);
                if (!response.ok) throw new Error('Failed to load settings');
                const settings = await response.json();
                document.getElementById('waybillHeader').value = settings.header || '';
                document.getElementById('waybillFooter').value = settings.footer || '';
                document.getElementById('waybillDisclaimer').value = settings.disclaimer || '';
                if (settings.logo) {
                    document.getElementById('logoData').value = settings.logo;
                    document.getElementById('logoPreview').innerHTML = `<img src="${settings.logo}" class="h-16 border rounded-md" alt="Logo Preview">`;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        };
        
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        const attachPageEventListeners = (pageId) => {
            if (pageId === 'dashboard') {
                document.getElementById('shipmentsTableBody').addEventListener('click', (event) => {
                    const target = event.target.closest('button');
                    if(!target) return;
                    const shipmentId = target.dataset.id;
                    if (target.classList.contains('print-waybill-btn') && shipmentId) {
                        window.open(`${API_URL}/shipments/${shipmentId}/waybill`, '_blank');
                    }
                     if (target.classList.contains('edit-shipment-btn') && shipmentId) {
                        openEditShipmentModal(shipmentId);
                    }
                    if (target.classList.contains('delete-shipment-btn') && shipmentId) {
                        const deleteModal = document.getElementById('deleteConfirmModal');
                        deleteModal.dataset.id = shipmentId;
                        deleteModal.dataset.type = 'shipment';
                        deleteModal.querySelector('p').textContent = 'Do you really want to delete this shipment? This process cannot be undone.';
                        deleteModal.classList.remove('hidden');
                    }
                });
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.getElementById('shipmentsTableBody').querySelectorAll('tr');
                    rows.forEach(row => {
                        const trackingNumberCell = row.querySelector('td:first-child');
                        if(trackingNumberCell){
                            const trackingNumber = trackingNumberCell.textContent.toLowerCase();
                            if (trackingNumber.includes(searchTerm)) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    });
                });
            } else if (pageId === 'create-shipment') {
                document.getElementById('shipmentForm').addEventListener('submit', async (event) => { 
                    event.preventDefault(); 
                    const saveBtn = document.getElementById('saveShipmentBtn');
                    saveBtn.textContent = 'Saving...'; 
                    saveBtn.disabled = true; 
                    const formData = new FormData(event.target); 
                    const shipmentData = Object.fromEntries(formData.entries()); 
                    
                    const elements = [];
                    const elementRows = document.querySelectorAll('#elementsList .element-row');
                     elementRows.forEach((row) => {
                        const descriptionInput = row.querySelector(`input[name^="element_description"]`);
                        const quantityInput = row.querySelector(`input[name^="element_quantity"]`);
                        if (descriptionInput && quantityInput && descriptionInput.value) {
                            elements.push({
                                description: descriptionInput.value,
                                quantity: quantityInput.value || '1'
                            });
                        }
                    });
                    shipmentData.elements = elements;

                    try { 
                        const response = await fetch(`${API_URL}/shipments`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(shipmentData), }); 
                        if (!response.ok) {
                             const err = await response.json();
                             throw new Error(err.message || 'Network response was not ok'); 
                        }
                        const result = await response.json(); 
                        alert(`Shipment created successfully!\nTracking Number: ${result.trackingNumber}`); 
                        const newShipments = await fetch(`${API_URL}/shipments`).then(res => res.json());
                        shipmentsCache = newShipments;
                        window.location.hash = '#dashboard';
                    } catch (error) { 
                        console.error('Error:', error); 
                        alert('There was an error creating the shipment: ' + error.message); 
                    } finally { 
                        saveBtn.textContent = 'Generate Waybill & Save'; 
                        saveBtn.disabled = false; 
                    } 
                });
                document.getElementById('cancelShipmentBtn').addEventListener('click', () => {
                    window.location.hash = '#dashboard';
                });
                document.getElementById('addElementBtn').addEventListener('click', () => {
                    const elementsList = document.getElementById('elementsList');
                    const elementCount = elementsList.querySelectorAll('.element-row').length + 1;
                    const newElementRow = document.createElement('div');
                    newElementRow.className = 'element-row flex items-center space-x-2';
                    newElementRow.innerHTML = `
                        <div class="w-8 text-slate-500">${elementCount}.</div>
                        <div class="flex-1 relative">
                            <input type="text" name="element_description_${elementCount}" class="element-input w-full px-3 py-2 border border-slate-300 rounded-md" autocomplete="off">
                            <div class="element-results search-results absolute z-10 w-full bg-white border border-slate-300 rounded-md mt-1 hidden"></div>
                        </div>
                        <div class="w-24"><input type="number" name="element_quantity_${elementCount}" class="w-full px-3 py-2 border border-slate-300 rounded-md" placeholder="Qty" value="1"></div>
                        <button type="button" class="remove-element-btn bg-red-500 text-white rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center hover:bg-red-600">-</button>
                    `;
                    elementsList.appendChild(newElementRow);
                });
                document.getElementById('elementsList').addEventListener('click', (event) => {
                    if (event.target.closest('.remove-element-btn')) {
                        event.target.closest('.element-row').remove();
                        document.getElementById('elementsList').querySelectorAll('.element-row').forEach((row, index) => {
                            row.querySelector('div:first-child').textContent = `${index + 1}.`;
                        });
                    }
                });
                handleAddressSearch(document.getElementById('senderName'), document.getElementById('senderResults'), document.getElementById('senderContact'), document.getElementById('senderAddress'));
                handleAddressSearch(document.getElementById('recipientName'), document.getElementById('recipientResults'), document.getElementById('recipientContact'), document.getElementById('recipientAddress'));
                document.getElementById('elementsList').addEventListener('input', (event) => {
                    if (event.target.classList.contains('element-input')) {
                        handleElementSearch(event.target, event.target.nextElementSibling);
                    }
                });
                
                document.getElementById('ceNumber').addEventListener('input', debounce(async (event) => {
                    const enteredCe = event.target.value.trim();
                    if (enteredCe.length < 3) return;
                    
                    try {
                        const response = await fetch(`${API_URL}/chase-jobs/by-ce/${enteredCe}`);
                        if(response.ok) {
                            const job = await response.json();
                             document.getElementById('associatedJobNo').value = job.jobNo || '';
                            document.getElementById('senderName').value = job.customerName || '';
                            document.getElementById('senderContact').value = job.accountExecutive || '';
                        }
                    } catch(error) {
                        console.log("No job found for this CE yet.");
                        document.getElementById('associatedJobNo').value = '';
                        document.getElementById('senderName').value = '';
                        document.getElementById('senderContact').value = '';
                    }
                }, 500));
            } else if (pageId === 'chase-jobs') {
                document.getElementById('openImportModalBtn').addEventListener('click', () => document.getElementById('importModal').classList.remove('hidden'));
                 document.getElementById('chaseSearchInput').addEventListener('input', debounce((e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    if (!searchTerm) {
                        displayChaseJobs(); 
                        return;
                    }
                    const filteredJobs = importedJobsCache.filter(job => 
                        (job.jobNo && job.jobNo.toLowerCase().includes(searchTerm)) ||
                        (job.ceNumbers && job.ceNumbers.toLowerCase().includes(searchTerm)) ||
                        (job.customerName && job.customerName.toLowerCase().includes(searchTerm))
                    );
                    displayChaseJobs(filteredJobs);
                }, 300));
            } else if (pageId === 'address-book') {
                document.getElementById('addAddressForm').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const newAddress = {
                        name: document.getElementById('addressName').value,
                        contactPerson: document.getElementById('addressContactPerson').value,
                        phone: document.getElementById('addressPhone').value,
                        address: document.getElementById('addressText').value,
                    };
                    try {
                        const response = await fetch(`${API_URL}/addresses`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newAddress)
                        });
                        if (!response.ok) throw new Error('Failed to save address');
                        event.target.reset();
                        const newAddresses = await fetch(`${API_URL}/addresses`).then(res => res.json());
                        addressBookCache = newAddresses;
                        displayAddresses();
                    } catch (error) {
                        alert('Error saving address.');
                    }
                });

                document.getElementById('addressBookTableBody').addEventListener('click', async (event) => {
                    const target = event.target.closest('button');
                    if (!target) return;
                    const addressId = target.dataset.id;

                    if (target.classList.contains('delete-address-btn') && addressId) {
                        const deleteModal = document.getElementById('deleteConfirmModal');
                        deleteModal.dataset.id = addressId;
                        deleteModal.dataset.type = 'address';
                        deleteModal.querySelector('p').textContent = 'Do you really want to delete this address? This process cannot be undone.';
                        deleteModal.classList.remove('hidden');
                    }

                    if (target.classList.contains('edit-address-btn') && addressId) {
                        const address = addressBookCache.find(addr => addr.id.toString() === addressId);
                        if (address) {
                            document.getElementById('editAddressId').value = address.id;
                            document.getElementById('editAddressName').value = address.name;
                            document.getElementById('editAddressContactPerson').value = address.contactPerson || '';
                            document.getElementById('editAddressPhone').value = address.phone || '';
                            document.getElementById('editAddressText').value = address.address;
                            document.getElementById('editAddressModal').classList.remove('hidden');
                        }
                    }
                });

            } else if (pageId === 'elements') {
                document.getElementById('addElementForm').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const newElement = {
                        brand: document.getElementById('elementBrand').value,
                        product: document.getElementById('elementProduct').value,
                        color: document.getElementById('elementColor').value,
                        description: document.getElementById('elementDescription').value,
                    };
                    try {
                        const response = await fetch(`${API_URL}/elements`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(newElement)
                        });
                        if (!response.ok) throw new Error('Failed to save element');
                        event.target.reset();
                        const newElements = await fetch(`${API_URL}/elements`).then(res => res.json());
                        elementsCache = newElements;
                        displayElements();
                    } catch (error) {
                        alert('Error saving element.');
                    }
                });

                document.getElementById('elementsTableBody').addEventListener('click', async (event) => {
                    const target = event.target.closest('button');
                    if (!target) return;
                    const elementId = target.dataset.id;

                    if (target.classList.contains('delete-element-btn') && elementId) {
                        const deleteModal = document.getElementById('deleteConfirmModal');
                        deleteModal.dataset.id = elementId;
                        deleteModal.dataset.type = 'element';
                        deleteModal.querySelector('p').textContent = 'Do you really want to delete this element? This process cannot be undone.';
                        deleteModal.classList.remove('hidden');
                    }

                    if (target.classList.contains('edit-element-btn') && elementId) {
                        const element = elementsCache.find(el => el.id.toString() === elementId);
                        if (element) {
                            document.getElementById('editElementId').value = element.id;
                            document.getElementById('editElementBrand').value = element.brand;
                            document.getElementById('editElementProduct').value = element.product || '';
                            document.getElementById('editElementColor').value = element.color || '';
                            document.getElementById('editElementDescription').value = element.description;
                            document.getElementById('editElementModal').classList.remove('hidden');
                        }
                    }
                });

            } else if (pageId === 'delivery-notes') {
                
                const updateDnTotals = () => {
                    const container = document.getElementById('dnItemsContainer');
                    let subtotal = 0;
                    container.querySelectorAll('.dn-item-row').forEach(row => {
                        const qty = parseFloat(row.querySelector('.dn-item-qty').value) || 0;
                        const price = parseFloat(row.querySelector('.dn-item-price').value) || 0;
                        subtotal += qty * price;
                    });
                    const vat = subtotal * 0.15;
                    const total = subtotal + vat;
                    document.getElementById('dnSubtotal').textContent = `R ${subtotal.toFixed(2)}`;
                    document.getElementById('dnVat').textContent = `R ${vat.toFixed(2)}`;
                    document.getElementById('dnTotal').textContent = `R ${total.toFixed(2)}`;
                };

                const addDnItemRow = () => {
                     const container = document.getElementById('dnItemsContainer');
                     const newRow = document.createElement('div');
                     newRow.className = 'dn-item-row grid grid-cols-12 gap-2 items-center';
                     newRow.innerHTML = `
                        <input type="number" class="dn-item-qty col-span-2 w-full px-2 py-1 border border-slate-300 rounded-md" placeholder="Qty" value="1" min="1">
                        <input type="text" class="dn-item-desc col-span-6 w-full px-2 py-1 border border-slate-300 rounded-md" placeholder="Description" required>
                        <input type="number" step="0.01" class="dn-item-price col-span-3 w-full px-2 py-1 border border-slate-300 rounded-md" placeholder="0.00" min="0" required>
                        <button type="button" class="remove-dn-item-btn col-span-1 bg-red-100 text-red-600 rounded-full w-6 h-6 flex-shrink-0 flex items-center justify-center hover:bg-red-200 text-sm">X</button>
                     `;
                     container.appendChild(newRow);
                };
                
                addDnItemRow(); // Add one row by default

                document.getElementById('addDnItemBtn').addEventListener('click', addDnItemRow);

                document.getElementById('dnItemsContainer').addEventListener('input', updateDnTotals);
                document.getElementById('dnItemsContainer').addEventListener('click', (e) => {
                    if (e.target.closest('.remove-dn-item-btn')) {
                        e.target.closest('.dn-item-row').remove();
                        updateDnTotals();
                    }
                });

                document.getElementById('addDeliveryNoteForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const items = [];
                    document.querySelectorAll('.dn-item-row').forEach(row => {
                        items.push({
                            quantity: parseFloat(row.querySelector('.dn-item-qty').value) || 0,
                            description: row.querySelector('.dn-item-desc').value,
                            price: parseFloat(row.querySelector('.dn-item-price').value), // Keep as number, even if 0
                        });
                    });

                    const noteData = {
                        clientName: document.getElementById('dnClientName').value,
                        date: document.getElementById('dnDate').value,
                        address: document.getElementById('dnAddress').value,
                        contactPerson: document.getElementById('dnContactPerson').value,
                        contactNumber: document.getElementById('dnContactNumber').value,
                        jobNo: document.getElementById('dnJobNo').value,
                        ceNumber: document.getElementById('dnCeNumber').value,
                        items: items.filter(item => item.description && item.quantity > 0 && typeof item.price === 'number'),
                    };

                    if (noteData.items.length === 0) {
                        alert('Please add at least one valid item with a description and quantity.');
                        return;
                    }

                    try {
                        const response = await fetch(`${API_URL}/delivery-notes`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(noteData) });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message);
                        alert('Delivery Note saved successfully!');
                        e.target.reset();
                        const itemsContainer = document.getElementById('dnItemsContainer');
                        itemsContainer.querySelectorAll('.dn-item-row').forEach(row => row.remove());
                        addDnItemRow();
                        updateDnTotals();
                        document.getElementById('dnDate').valueAsDate = new Date();
                        deliveryNotesCache = await fetch(`${API_URL}/delivery-notes`).then(res => res.json());
                        displayDeliveryNotes();
                    } catch (error) {
                        alert(`Error: ${error.message}`);
                    }
                });

                document.getElementById('deliveryNotesTableBody').addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const noteId = target.dataset.id;
                    if (target.classList.contains('print-dn-btn')) {
                        window.open(`${API_URL}/delivery-notes/${noteId}/pdf`, '_blank');
                    }
                    if (target.classList.contains('delete-dn-btn')) {
                        const deleteModal = document.getElementById('deleteConfirmModal');
                        deleteModal.dataset.id = noteId;
                        deleteModal.dataset.type = 'delivery-note';
                        deleteModal.querySelector('p').textContent = 'Do you really want to delete this delivery note? This process cannot be undone.';
                        deleteModal.classList.remove('hidden');
                    }
                });

            } else if (pageId === 'settings') {
                document.getElementById('settingsForm').addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(event.target);
                    const settingsData = Object.fromEntries(formData.entries());
                    try {
                        const response = await fetch(`${API_URL}/settings/waybill`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(settingsData)
                        });
                        if (!response.ok) throw new Error('Failed to save settings');
                        alert('Settings saved successfully!');
                    } catch (error) {
                        alert('Error saving settings.');
                    }
                });
                document.getElementById('logoUpload').addEventListener('change', () => {
                    const file = document.getElementById('logoUpload').files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('logoData').value = e.target.result;
                            document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" class="h-16 border rounded-md" alt="New Logo Preview">`;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        };

        const renderPage = (pageId) => {
            mainContent.innerHTML = pages[pageId] || pages.dashboard;
            const activeLink = document.querySelector(`.nav-link[href="#${pageId}"]`);
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-slate-900/50', 'text-indigo-400', 'font-semibold'));
            if(activeLink) activeLink.classList.add('bg-slate-900/50', 'text-indigo-400', 'font-semibold');

            if (pageId === 'dashboard') displayShipments();
            else if (pageId === 'chase-jobs') displayChaseJobs();
            else if (pageId === 'address-book') displayAddresses();
            else if (pageId === 'elements') displayElements();
            else if (pageId === 'delivery-notes') displayDeliveryNotes();
            else if (pageId === 'create-shipment') populateJobsDropdown();
            else if (pageId === 'settings') loadSettings();
            attachPageEventListeners(pageId);
        };

        const openEditShipmentModal = async (trackingNumber) => {
            try {
                const response = await fetch(`${API_URL}/shipments/${trackingNumber}`);
                if (!response.ok) throw new Error('Failed to fetch shipment details.');
                const shipment = await response.json();
                
                const form = document.getElementById('editShipmentForm');
                form.innerHTML = `
                    <input type="hidden" name="trackingNumber" value="${shipment.trackingNumber}">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Sender Section -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700 border-b pb-2">Sender Information</h4>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Job Number</label><input type="text" name="associatedJobNo" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.associatedJobNo || ''}"></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">CE Number</label><input type="text" name="ceNumber" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.ceNumber || ''}"></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Company / Customer Name</label><input type="text" name="senderName" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.senderName || ''}" required></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Contact Person (AE)</label><input type="text" name="senderContact" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.senderContact || ''}"></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Collection Address</label><textarea name="senderAddress" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required>${shipment.senderAddress || ''}</textarea></div>
                        </div>
                        <!-- Recipient Section -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-slate-700 border-b pb-2">Recipient Information</h4>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Name</label><input type="text" name="recipientName" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.recipientName || ''}" required></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Contact Person</label><input type="text" name="recipientContact" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${shipment.recipientContact || ''}"></div>
                            <div><label class="block text-sm font-medium text-slate-600 mb-1">Address</label><textarea name="recipientAddress" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md" required>${shipment.recipientAddress || ''}</textarea></div>
                             <div><label class="block text-sm font-medium text-slate-600 mb-1">Status</label><select name="status" class="w-full px-3 py-2 border border-slate-300 rounded-md"><option>Pending</option><option>In Transit</option><option>Out for Delivery</option><option>Delivered</option><option>Delayed</option></select></div>
                             <div><label class="block text-sm font-medium text-slate-600 mb-1">Courier Charge (R)</label><input type="number" name="courier_charge" class="w-full px-3 py-2 border border-slate-300 rounded-md" step="0.01" value="${shipment.courier_charge || ''}" placeholder="0.00"></div>
                        </div>
                        <!-- Elements -->
                        <div class="md:col-span-2">
                             <h4 class="text-lg font-semibold text-slate-700 border-b pb-2">Elements</h4>
                             <div id="editElementsList" class="space-y-2 mt-2"></div>
                             <button type="button" id="addEditElementBtn" class="mt-2 text-sm text-indigo-600 hover:underline">+ Add Element</button>
                        </div>
                    </div>
                    <div class="flex justify-end items-center pt-6 border-t mt-4">
                        <button type="button" id="cancelEditShipmentBtn" class="text-slate-600 font-semibold py-2 px-4 rounded-lg mr-4">Cancel</button>
                        <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg">Save Changes</button>
                    </div>
                `;
                
                form.querySelector('select[name="status"]').value = shipment.status;

                const elementsList = form.querySelector('#editElementsList');
                (shipment.elements || []).forEach((el, index) => {
                    const newElementRow = document.createElement('div');
                    newElementRow.className = 'element-row flex items-center space-x-2';
                    newElementRow.innerHTML = `
                        <div class="w-8 text-slate-500">${index + 1}.</div>
                        <div class="flex-1"><input type="text" name="element_description_${index + 1}" class="element-input w-full px-3 py-2 border border-slate-300 rounded-md" value="${el.description}"></div>
                        <div class="w-24"><input type="number" name="element_quantity_${index + 1}" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="${el.quantity}"></div>
                        <button type="button" class="remove-element-btn bg-red-500 text-white rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center hover:bg-red-600">-</button>
                    `;
                    elementsList.appendChild(newElementRow);
                });

                document.getElementById('editShipmentModal').classList.remove('hidden');

            } catch(error) {
                console.error("Error opening edit modal:", error);
                alert("Could not load shipment details for editing.");
            }
        };

        // --- Auth Flow ---
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            loginPage.classList.add('hidden');
            registerPage.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            registerPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!response.ok) {
                    const result = await response.json().catch(() => ({ message: 'Invalid response from server.' }));
                    throw new Error(result.message);
                }
                sessionStorage.setItem('loggedInUser', username);
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loggedInUser.textContent = username;
                window.location.hash = '#dashboard';
                loadInitialData(); // Load data after successful login
            } catch (error) {
                alert(`Login failed: ${error.message}`);
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                alert('Registration successful! Please log in.');
                registerPage.classList.add('hidden');
                loginPage.classList.remove('hidden');
            } catch (error) {
                alert(`Registration failed: ${error.message}`);
            }
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('loggedInUser');
            shipmentsCache = [];
            importedJobsCache = [];
            addressBookCache = [];
            elementsCache = [];
            appContainer.classList.add('hidden');
            authContainer.classList.remove('hidden');
            loginPage.classList.remove('hidden');
            registerPage.classList.add('hidden');
             window.location.hash = '';
        });

        // --- Initial Load & Global Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            const user = sessionStorage.getItem('loggedInUser');
            if (user) {
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loggedInUser.textContent = user;
                loadInitialData();
            }

            window.addEventListener('hashchange', () => {
                const newPageId = window.location.hash.substring(1) || 'dashboard';
                renderPage(newPageId);
            });

            // Modal closing logic
            [document.getElementById('closeUpdateModalBtn'), document.getElementById('cancelUpdateModalBtn')].forEach(btn => btn.addEventListener('click', () => document.getElementById('updateStatusModal').classList.add('hidden')));
            [document.getElementById('closeImportModalBtn'), document.getElementById('cancelImportModalBtn')].forEach(btn => btn.addEventListener('click', () => document.getElementById('importModal').classList.add('hidden')));
            [document.getElementById('closeEditAddressModalBtn'), document.getElementById('cancelEditAddressModalBtn')].forEach(btn => btn.addEventListener('click', () => document.getElementById('editAddressModal').classList.add('hidden')));
            [document.getElementById('closeEditElementModalBtn'), document.getElementById('cancelEditElementModalBtn')].forEach(btn => btn.addEventListener('click', () => document.getElementById('editElementModal').classList.add('hidden')));
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => document.getElementById('deleteConfirmModal').classList.add('hidden'));
            document.getElementById('closeEditShipmentModalBtn').addEventListener('click', () => document.getElementById('editShipmentModal').classList.add('hidden'));
            
            document.getElementById('updateStatusForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const shipmentId = document.getElementById('updateShipmentId').value;
                const newStatus = document.getElementById('newStatus').value;
                 try {
                     const response = await fetch(`${API_URL}/shipments/${shipmentId}/status`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                     if (!response.ok) throw new Error('Failed to update status');
                     document.getElementById('updateStatusModal').classList.add('hidden');
                     const newShipments = await fetch(`${API_URL}/shipments`).then(res => res.json());
                     shipmentsCache = newShipments;
                     displayShipments();
                 } catch (error) { alert('Error updating status.'); }
            });

            document.getElementById('importForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById('submitImportBtn');
                submitBtn.textContent = 'Importing...';
                submitBtn.disabled = true;
                const username = document.getElementById('apiUsername').value;
                const password = document.getElementById('apiPassword').value;
                try {
                     const response = await fetch(`${API_URL}/chase/import`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
                     const result = await response.json();
                     if (!response.ok) throw new Error(result.message);
                     alert(result.message);
                     document.getElementById('importModal').classList.add('hidden');
                     await loadInitialData();
                } catch(error) {
                     alert(`Import failed: ${error.message}`);
                } finally {
                    submitBtn.textContent = 'Import Jobs';
                    submitBtn.disabled = false;
                }
            });

            document.getElementById('editAddressForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const addressId = document.getElementById('editAddressId').value;
                const updatedAddress = { name: document.getElementById('editAddressName').value, contactPerson: document.getElementById('editAddressContactPerson').value, phone: document.getElementById('editAddressPhone').value, address: document.getElementById('editAddressText').value };
                try {
                    const response = await fetch(`${API_URL}/addresses/${addressId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedAddress) });
                    if (!response.ok) throw new Error('Failed to update address');
                    document.getElementById('editAddressModal').classList.add('hidden');
                    const newAddresses = await fetch(`${API_URL}/addresses`).then(res => res.json());
                    addressBookCache = newAddresses;
                    displayAddresses();
                } catch (error) { alert('Error updating address.'); console.error('Update error:', error); }
            });
            
            document.getElementById('editElementForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const elementId = document.getElementById('editElementId').value;
                const updatedElement = { brand: document.getElementById('editElementBrand').value, product: document.getElementById('editElementProduct').value, color: document.getElementById('editElementColor').value, description: document.getElementById('editElementDescription').value };
                try {
                    const response = await fetch(`${API_URL}/elements/${elementId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedElement) });
                    if (!response.ok) throw new Error('Failed to update element');
                    document.getElementById('editElementModal').classList.add('hidden');
                    const newElements = await fetch(`${API_URL}/elements`).then(res => res.json());
                    elementsCache = newElements;
                    displayElements();
                } catch (error) { alert('Error updating element.'); console.error('Update error:', error); }
            });

             document.getElementById('editShipmentForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);
                const shipmentData = Object.fromEntries(formData.entries());
                const trackingNumber = shipmentData.trackingNumber;

                const elements = [];
                const elementRows = document.querySelectorAll('#editElementsList .element-row');
                elementRows.forEach(row => {
                    const descriptionInput = row.querySelector('input[name^="element_description"]');
                    const quantityInput = row.querySelector('input[name^="element_quantity"]');
                    if (descriptionInput && quantityInput && descriptionInput.value) {
                        elements.push({ description: descriptionInput.value, quantity: quantityInput.value || '1' });
                    }
                });
                shipmentData.elements = elements;

                try {
                    const response = await fetch(`${API_URL}/shipments/${trackingNumber}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(shipmentData) });
                    if (!response.ok) throw new Error('Failed to update shipment');
                    document.getElementById('editShipmentModal').classList.add('hidden');
                    const newShipments = await fetch(`${API_URL}/shipments`).then(res => res.json());
                    shipmentsCache = newShipments;
                    displayShipments();
                } catch (error) {
                    alert('Error updating shipment.');
                    console.error('Update error:', error);
                }
            });

            document.getElementById('editShipmentModal').addEventListener('click', (event) => {
                if (event.target.id === 'cancelEditShipmentBtn') {
                    document.getElementById('editShipmentModal').classList.add('hidden');
                }
                if (event.target.id === 'addEditElementBtn') {
                    const elementsList = document.getElementById('editElementsList');
                    const elementCount = elementsList.querySelectorAll('.element-row').length + 1;
                    const newElementRow = document.createElement('div');
                    newElementRow.className = 'element-row flex items-center space-x-2';
                    newElementRow.innerHTML = `
                        <div class="w-8 text-slate-500">${elementCount}.</div>
                        <div class="flex-1"><input type="text" name="element_description_${elementCount}" class="w-full px-3 py-2 border border-slate-300 rounded-md"></div>
                        <div class="w-24"><input type="number" name="element_quantity_${elementCount}" class="w-full px-3 py-2 border border-slate-300 rounded-md" value="1"></div>
                        <button type="button" class="remove-element-btn bg-red-500 text-white rounded-full w-8 h-8 flex-shrink-0 flex items-center justify-center hover:bg-red-600">-</button>
                    `;
                    elementsList.appendChild(newElementRow);
                }
                if (event.target.classList.contains('remove-element-btn')) {
                    event.target.closest('.element-row').remove();
                    document.getElementById('editElementsList').querySelectorAll('.element-row').forEach((row, index) => {
                        row.querySelector('div:first-child').textContent = `${index + 1}.`;
                    });
                }
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                const deleteModal = document.getElementById('deleteConfirmModal');
                const id = deleteModal.dataset.id;
                const type = deleteModal.dataset.type;
                let url = '';
                let callback;

                if (type === 'address') { url = `${API_URL}/addresses/${id}`; callback = async () => { addressBookCache = await fetch(`${API_URL}/addresses`).then(res => res.json()); displayAddresses(); }; } 
                else if (type === 'element') { url = `${API_URL}/elements/${id}`; callback = async () => { elementsCache = await fetch(`${API_URL}/elements`).then(res => res.json()); displayElements(); }; }
                else if (type === 'shipment') { url = `${API_URL}/shipments/${id}`; callback = async () => { shipmentsCache = await fetch(`${API_URL}/shipments`).then(res => res.json()); displayShipments(); }; }
                else if (type === 'delivery-note') { url = `${API_URL}/delivery-notes/${id}`; callback = async () => { deliveryNotesCache = await fetch(`${API_URL}/delivery-notes`).then(res => res.json()); displayDeliveryNotes(); }; }

                if (id && url) {
                    try {
                        const response = await fetch(url, { method: 'DELETE' });
                        if (!response.ok) throw new Error(`Failed to delete ${type}`);
                        deleteModal.classList.add('hidden');
                        await callback();
                    } catch (error) { alert(`Error deleting ${type}.`); console.error('Delete error:', error); }
                }
            });
        });
    </script>
</body>
</html>

